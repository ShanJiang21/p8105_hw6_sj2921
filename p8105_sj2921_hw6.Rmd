---
title: "p8105_hw6_sj2921"
author: "Shan Jiang"
date: "11/16/2018"
output: html_document
---
## problem 1
```{r}
library(tidyverse)
library(broom)
```

```{r}
### Import the raw data.
require(RCurl)
homicide_raw = read.csv( text = getURL("https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv")) 
```

### 1.1 Tidy the dataset

```{r}
homicide_df = homicide_raw %>% 
  mutate(city_state = str_c(city, state, sep = "," )) %>% 
  mutate(city_state = as.factor(city_state)) %>% 
  group_by(city_state) %>% ## add the binary variable 
  filter(!city_state %in% c("Dallas,TX", "Phoenix,AZ","Kansas City,MO","Tulsa,AL" )) %>%
  mutate(case_status = ifelse(disposition == "Closed by arrest", 0, 1)) %>%
   ### relevel `victim_race`
  mutate(victim_race = fct_collapse(victim_race,  
           non_white = c("Hispanic","Black", "Asian", "Other", "Unknown"),
           white = "White")) %>% 
  mutate(victim_race = fct_relevel(victim_race, "white")) %>% 
  ## change the victim_age as numeric
  mutate(victim_age = as.numeric(victim_age)) 
  
```

Since there are three levels for the factor of disposition, we need to recode it as whether the homicide is solved or not: for *Closed by arrest*, we coined it as 0 while  adding 1 for "*Open/No arrest*" or "*closed without arrest*".

* For categories white and non-white, with white as the reference category. 


### 1.2 Simulation

For the city of Baltimore, MD, use the `glm` function to fit a logistic regression with resolved vs unresolved as the outcome and victim age, race(as just classified) and sex as predictors. 

```{r}
fit_logistic = 
  homicide_df %>% 
  filter(city == "Baltimore") %>% 
  glm(case_status ~ victim_age + victim_race + victim_sex, data = .) 

## Obtain the estimate and confidence interval of the adjusted odds ratio for solving homicides comparing non-white victims to white victims keeping all other variables fixed.
fit_logistic %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate)) %>%
  mutate(CI.lower =  exp(estimate - std.error * statistic)) %>% 
  mutate(CI.higher =  exp(estimate + std.error * statistic)) %>%
  select(term, log_OR = estimate, OR, p.value, CI.lower, CI.higher) %>% 
  knitr::kable(digits = 3)
```

## Each city:Compare the white and non-white values 

Do this within a “tidy” pipeline, making use of `purrr::map`, `list columns`, and unnest as necessary to create a dataframe with estimated ORs and CIs for each city.

```{r}
## Create a list column for the city_state dataset
homicide_nest = homicide_df %>% 
  group_by(city_state) %>% 
  nest(homicide_df, victim_race:case_status)

head(homicide_nest)

## Create a glm function 
homicide_glm  = function(df) {
  glm = glm(case_status ~ victim_age + victim_race + victim_sex, data = homicide_df, family = binomial()) %>% 
        broom::tidy() 
       
     glm 
}


## Apply to each city, state 

 homicide_nest =  homicide_nest %>% 
    mutate(models = map(homicide_nest$data, homicide_glm )) %>% 
    select(-data) %>% 
    unnest() %>% 
    mutate(OR = exp(estimate)) %>%
        mutate(CI.low =  exp(estimate - std.error * statistic) ) %>% 
        mutate(CI.high =  exp(estimate + std.error * statistic)) %>% 
        filter(term == "victim_racenon_white") %>% 
        select(term, log_OR = estimate, OR, p.value, CI.lower, CI.higher) 
```

Create a plot that shows the estimated ORs and CIs for each city. Organize cities according to estimated OR, and comment on the plot.

```{r}
homicide_nest %>% 
 mutate(city_state = fct_reorder(city_state, OR)) %>% 
  ggplot(aes(x = city_state, y = OR)) + 
  geom_point() + 
  geom_errorbar(mapping = aes(ymin = CI.low, ymax = CI.high )) +
  theme_classic() +
  theme(legend.position = "bottom",
        legend.direction = "horizontal",
        axis.text.x = element_text(angle = 90, size = 8))


```


## Problem 2

### Importation and cleaning the data 
```{r}
birth_weight = read_csv("./Data/birthweight.csv") 
  
birth_weight = birth_weight %>% 
    mutate(babysex = as.factor(babysex)) %>% 
    mutate(bhead = as.numeric(bhead), 
            mrace = as.factor(mrace),
            frace = as.factor(frace) ,
            bwt = as.numeric(bwt)) %>% 
    mutate(mheight = as.numeric(mheight)) %>% 
    mutate(mheight = as.numeric(mheight)) 
  
  
      
  
  


```

There are `nrow(birth_weight)` observations and `ncol(birth_weight)` variables in the dataset. 




