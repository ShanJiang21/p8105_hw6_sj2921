---
title: "p8105_hw6_sj2921"
author: "Shan Jiang"
date: "11/16/2018"
output: html_document
---
## problem 1
```{r}
library(tidyverse)
library(broom)
```

```{r}
### Import the raw data.
require(RCurl)
homicide_raw = read.csv( text = getURL("https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv")) 
```

### 1.1 Tidy the dataset

```{r}
homicide_df = homicide_raw %>% 
  mutate(city_state = str_c(city, state, sep = "," )) %>% 
  mutate(city_state = as.factor(city_state)) %>% 
  group_by(city_state) %>% ## add the binary variable 
  filter(!city_state %in% c("Dallas,TX", "Phoenix,AZ","Kansas City,MO","Tulsa,AL" )) %>%
  mutate(case_status = ifelse(disposition == "Closed by arrest", 0, 1)) %>%
   ### relevel `victim_race`
  mutate(victim_race = fct_collapse(victim_race,  
           non_white = c("Hispanic","Black", "Asian", "Other", "Unknown"),
           white = "White")) %>% 
  mutate(victim_race = fct_relevel(victim_race, "white")) %>% 
  ## change the victim_age as numeric
  mutate(victim_age = as.numeric(victim_age)) 
  
```

Since there are three levels for the factor of disposition, we need to recode it as whether the homicide is solved or not: for *Closed by arrest*, we coined it as 0 while  adding 1 for "*Open/No arrest*" or "*closed without arrest*".

* For categories white and non-white, with white as the reference category. 


### 1.2 Simulation

For the city of Baltimore, MD, use the `glm` function to fit a logistic regression with resolved vs unresolved as the outcome and victim age, race(as just classified) and sex as predictors. 

```{r}
fit_logistic = 
  homicide_df %>% 
  filter(city == "Baltimore") %>% 
  group_by(victim_race) %>% 
  glm(case_status ~ victim_age + victim_race + victim_sex, data = .) 

## Obtain the estimate and confidence interval of the adjusted odds ratio for solving homicides comparing non-white victims to white victims keeping all other variables fixed.
fit_logistic %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate)) %>%
  mutate(confidence interval)
  select(term, log_OR = estimate, OR, p.value) %>% 
  knitr::kable(digits = 3)
```

Now run glm for each of the cities in your dataset. 


Extract the adjusted odds ratio (and CI) for solving homicides comparing black victims to white victims. 

Do this within a “tidy” pipeline, making use of `purrr::map`, `list columns`, and unnest as necessary to create a dataframe with estimated ORs and CIs for each city.

```{r}



```


Create a plot that shows the estimated ORs and CIs for each city. Organize cities according to estimated OR, and comment on the plot.


## Problem 2

```{r}

```

